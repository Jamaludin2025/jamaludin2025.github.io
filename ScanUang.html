<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Scan Uang Tabungan</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <script src="https://unpkg.com/feather-icons"></script>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      margin: 0;
      padding: 1rem;
      background-color: #f2f2f2;
      color: #333;
    }

    .container {
      max-width: 480px;
      margin: auto;
      background: #fff;
      padding: 1rem;
      border-radius: 10px;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
      display: none;
    }

    .image {
      display: block;
      margin: 0 auto 30px auto;
      width: 120px;
    }

    h2 {
      text-align: center;
      margin-bottom: 0.5rem;
    }

    .date {
      text-align: left;
      font-size: 0.9rem;
      color: #777;
      margin-bottom: 0.5rem;
    }

    hr {
      border: none;
      border-top: 1px solid #ccc;
      margin: 0.5rem 0 1rem;
    }

    canvas {
      display: block;
      margin: 0 auto 1rem auto;
    }

    .info {
      margin-bottom: 0.6rem;
      display: flex;
      flex-wrap: wrap;
      align-items: flex-start;
    }

    .info b {
      width: 90px;
      margin-right: 6px;
    }

    .seri-list2 {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      font-size: 0.95rem;
      line-height: 1.6;
    }

    .seri-list2 .col {
      display: flex;
      flex-direction: column;
    }

    .buttons {
      display: flex;
      justify-content: space-around;
      margin-top: 1rem;
    }

    .buttons button {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 5px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 14px;
    }

    .edit-btn {
      background-color: orange;
      color: white;
    }

    .hapus-btn {
      background-color: red;
      color: white;
    }

    .buttons .edit-btn svg,
    .buttons .hapus-btn svg {
      width: 16px;
      height: 16px;
      vertical-align: middle;
    }

    #formEdit {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px dashed #aaa;
    }

    #formEdit label {
      font-weight: bold;
      display: block;
      margin-top: 10px;
    }

    #formEdit input,
    #formEdit select {
      width: 100%;
      padding: 8px;
      margin-top: 4px;
      border: 1px solid #ccc;
      border-radius: 5px;
      box-sizing: border-box;
      font-size: 14px;
    }

    #formEdit button {
      margin-top: 12px;
      background: #4caf50;
      color: white;
      border: none;
      padding: 10px;
      width: 100%;
      border-radius: 6px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
    }

    #formEdit button:hover {
      background: #3c9b40;
    }

    #penggunaanInfo {
      background: #f9f9f9;
      padding: 10px;
      border-radius: 6px;
      margin-top: 10px;
      font-size: 0.95rem;
      line-height: 1.5;
    }
  </style>
</head>
<body>
  <div class="container" id="resultContainer">
    <img class="image" src="https://res.cloudinary.com/dz4w1sqiv/image/upload/v1751588603/Tabungan Asep Jamaludin.png" alt="Ikon Tabungan" />
    <a href="https://jamaludin2025.github.io/ScanUang.html" target="_blank">
      <h2 id="judul">Uang Tabungan</h2>
    </a>

    <div class="date" id="tanggal"></div>
    <hr />
    <canvas id="barcode"></canvas>

    <div class="info"><b>Kode</b>: <span id="kode"></span></div>
    <div class="info"><b>Nominal</b>: <span id="nominal"></span></div>
    <div class="info"><b>Pecahan</b>: <span id="pecahan"></span></div>
    <div class="info"><b>No. Seri</b>: <div class="seri-list2" id="seriList"></div></div>

    <div id="penggunaanInfo"></div>

    <div id="formEdit" style="display:none;">
      <label>Digunakan untuk:</label>
      <select id="tipeGunakan" onchange="ubahTipeGunakan()">
        <option value="">Pilih</option>
        <option value="pribadi">Digunakan Pribadi</option>
        <option value="pinjam">Dipinjamkan</option>
      </select>

      <div id="formPribadi" style="display:none;">
        <label for="tglPribadi">Tanggal</label>
        <input type="date" id="tglPribadi" />
        <label for="ketPribadi">Keterangan</label>
        <input type="text" id="ketPribadi" placeholder="Misal: bayar listrik" />
      </div>

      <div id="formPinjam" style="display:none;">
        <label for="tglPinjam">Tanggal</label>
        <input type="date" id="tglPinjam" />
        <label for="kepada">Kepada Siapa</label>
        <input type="text" id="kepada" placeholder="Misal: Andi" />
        <label for="ketPinjam">Untuk Apa</label>
        <input type="text" id="ketPinjam" placeholder="Misal: kebutuhan usaha" />
      </div>

      <button onclick="simpanPenggunaan()">Simpan</button>
    </div>

    <div class="buttons">
      <button class="edit-btn" onclick="editData()">
        <i data-feather="edit"></i> EDIT
      </button>
      <button class="hapus-btn" onclick="hapusData()">
        <i data-feather="trash-2"></i> HAPUS
      </button>
    </div>
  </div>

  <div id="reader" style="width: 100%; margin-top: 1rem;"></div>

  <script>
    feather.replace();
  </script>
</body>
</html>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBdt-2IQflUWNx3sdI1QHPMe1vAzsXAZcY",
      authDomain: "ajproject-log.firebaseapp.com",
      databaseURL: "https://ajproject-log-default-rtdb.firebaseio.com",
      projectId: "ajproject-log",
      storageBucket: "ajproject-log.appspot.com",
      messagingSenderId: "113688767697",
      appId: "1:113688767697:web:b7b4c401f87702cd74a9f0"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let currentKode = "";

    function formatTanggal(tgl) {
      if (!tgl) return "(tidak ada tanggal)";
      const d = new Date(tgl);
      return `${String(d.getDate()).padStart(2, '0')}-${String(d.getMonth() + 1).padStart(2, '0')}-${d.getFullYear()}`;
    }

    function tampilkanData(data) {
      document.getElementById('resultContainer').style.display = 'block';
      document.getElementById('judul').innerText = `Uang Tabungan`;
      document.getElementById('tanggal').innerText = `Data ditambahkan pada ${formatTanggal(data.tanggal)}`;
      document.getElementById('kode').innerText = data.kode || '-';
      document.getElementById('nominal').innerText = data.nominal || '-';
      document.getElementById('pecahan').innerText = data.pecahan || '-';

      currentKode = data.kode;

      const canvas = document.getElementById("barcode");
      const ctx = canvas.getContext("2d");
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      if (data.kode) {
        JsBarcode(canvas, data.kode, {
          format: "CODE128",
          displayValue: false,
          lineColor: "#000",
          width: 2,
          height: 60
        });
      }

      const seriContainer = document.getElementById("seriList");
      seriContainer.innerHTML = "";
      const seriList = data.seri || [];
      const filtered = seriList.filter(s => s.trim() !== "");
      const kolom1 = filtered.slice(0, 10);
      const kolom2 = filtered.slice(10, 20);

      const col1 = document.createElement("div");
      col1.className = "col";
      kolom1.forEach(s => {
        const div = document.createElement("div");
        div.textContent = s;
        col1.appendChild(div);
      });

      const col2 = document.createElement("div");
      col2.className = "col";
      kolom2.forEach(s => {
        const div = document.createElement("div");
        div.textContent = s;
        col2.appendChild(div);
      });

      seriContainer.appendChild(col1);
      seriContainer.appendChild(col2);

      tampilkanPenggunaan(data.penggunaan);
    }

    function tampilkanPenggunaan(p) {
      const div = document.getElementById("penggunaanInfo");
      if (!p) {
        div.innerHTML = `<b>Penggunaan:</b><br/><i>Belum ada catatan.</i>`;
        return;
      }

      let teks = `<b>Penggunaan:</b><br/>`;
      if (p.tipe === "pribadi") {
        teks += `Digunakan pribadi pada ${formatTanggal(p.tanggal)} untuk ${p.keterangan}.`;
      } else if (p.tipe === "pinjam") {
        teks += `Dipinjamkan kepada ${p.kepada} pada ${formatTanggal(p.tanggal)} untuk ${p.keterangan}.`;
      }
      div.innerHTML = teks;
    }

    function hapusData() {
      const password = prompt("Masukkan password untuk menghapus data:");
      if (password !== "Hapus123") {
        alert("Password salah!");
        return;
      }
      db.ref("uang/" + currentKode).remove()
        .then(() => {
          alert("Data berhasil dihapus.");
          location.reload();
        })
        .catch(e => alert("Gagal menghapus data: " + e.message));
    }

    function editData() {
      const pass = prompt("Masukkan password edit:");
      if (pass !== "Edit123") {
        alert("Password salah.");
        return;
      }
      document.getElementById("formEdit").style.display = "block";
    }

    function ubahTipeGunakan() {
      const tipe = document.getElementById("tipeGunakan").value;
      document.getElementById("formPribadi").style.display = tipe === "pribadi" ? "block" : "none";
      document.getElementById("formPinjam").style.display = tipe === "pinjam" ? "block" : "none";
    }

    function simpanPenggunaan() {
      const tipe = document.getElementById("tipeGunakan").value;
      let penggunaan = { tipe };

      if (tipe === "pribadi") {
        penggunaan.tanggal = document.getElementById("tglPribadi").value;
        penggunaan.keterangan = document.getElementById("ketPribadi").value.trim();
      } else if (tipe === "pinjam") {
        penggunaan.tanggal = document.getElementById("tglPinjam").value;
        penggunaan.kepada = document.getElementById("kepada").value.trim();
        penggunaan.keterangan = document.getElementById("ketPinjam").value.trim();
      } else {
        alert("Pilih jenis penggunaan terlebih dahulu.");
        return;
      }

      db.ref("uang/" + currentKode + "/penggunaan").set(penggunaan)
        .then(() => {
          alert("Penggunaan berhasil disimpan.");
          tampilkanPenggunaan(penggunaan);
          document.getElementById("formEdit").style.display = "none";
        })
        .catch(e => alert("Gagal menyimpan: " + e.message));
    }

    const html5QrCode = new Html5Qrcode("reader");
    html5QrCode.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 250 },
      (decodedText) => {
        html5QrCode.stop();
        db.ref("uang/" + decodedText).once("value").then(snapshot => {
          if (snapshot.exists()) {
            tampilkanData(snapshot.val());
          } else {
            alert("Data tidak ditemukan!");
            location.reload();
          }
        });
      },
      () => {}
    ).catch(err => {
      alert("Gagal mengakses kamera: " + err);
    });
  </script>
</body>
</html>
