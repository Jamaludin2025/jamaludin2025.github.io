<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Scan Uang</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script src="https://cdn.jsdelivr.net/jsbarcode/3.11.5/JsBarcode.all.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f2f2f2;
      padding: 1rem;
    }
    .container {
      max-width: 480px;
      margin: auto;
      background: #fff;
      padding: 1rem;
      border-radius: 10px;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
      display: none;
    }
    h2 {
      text-align: center;
    }
    .info {
      margin: 0.5rem 0;
    }
    .seri-list {
      display: flex;
      gap: 1rem;
      margin-top: 0.5rem;
    }
    .seri-column {
      flex: 1;
    }
    .seri-column li {
      list-style: disc;
      margin-left: 1.2rem;
    }
    svg {
      display: block;
      margin: 1rem auto;
    }
    #reader {
      margin-top: 1rem;
    }
  </style>
</head>
<body>
  <div class="container" id="resultContainer">
    <h2>Detail Uang</h2>
    <div class="info"><b>Kode:</b> <span id="kode"></span></div>
    <div class="info"><b>Nominal:</b> <span id="nominal"></span></div>
    <div class="info"><b>Pecahan:</b> <span id="pecahan"></span></div>
    <div class="info"><b>Tanggal:</b> <span id="tanggal"></span></div>
    <svg id="barcode"></svg>

    <div class="info"><b>Nomor Seri:</b></div>
    <div class="seri-list">
      <ul class="seri-column" id="seri-col-1"></ul>
      <ul class="seri-column" id="seri-col-2"></ul>
    </div>
  </div>

  <div id="reader"></div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBdt-2IQflUWNx3sdI1QHPMe1vAzsXAZcY",
      authDomain: "ajproject-log.firebaseapp.com",
      databaseURL: "https://ajproject-log-default-rtdb.firebaseio.com",
      projectId: "ajproject-log",
      storageBucket: "ajproject-log.appspot.com",
      messagingSenderId: "113688767697",
      appId: "1:113688767697:web:b7b4c401f87702cd74a9f0"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const html5QrCode = new Html5Qrcode("reader");

    function formatTanggal(tgl) {
      if (!tgl) return "-";
      const d = new Date(tgl);
      return `${String(d.getDate()).padStart(2, '0')}-${String(d.getMonth()+1).padStart(2, '0')}-${d.getFullYear()}`;
    }

    function tampilkanData(data) {
      document.getElementById('resultContainer').style.display = 'block';
      document.getElementById('kode').textContent = data.kode || "-";
      document.getElementById('nominal').textContent = data.nominal || "-";
      document.getElementById('pecahan').textContent = data.pecahan || "-";
      document.getElementById('tanggal').textContent = formatTanggal(data.tanggal);

      // Tampilkan barcode dari kode
      JsBarcode("#barcode", data.kode || '', {
        format: "CODE128",
        displayValue: false,
        width: 2,
        height: 60
      });

      // Tampilkan seri
      const col1 = document.getElementById("seri-col-1");
      const col2 = document.getElementById("seri-col-2");
      col1.innerHTML = '';
      col2.innerHTML = '';

      const seriList = data.seri || [];
      for (let i = 0; i < 20; i++) {
        const s = seriList[i] || "-";
        const li = document.createElement('li');
        li.textContent = s;
        (i % 2 === 0 ? col1 : col2).appendChild(li);
      }
    }

    // Mulai kamera & scan
    html5QrCode.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 250 },
      (decodedText) => {
        html5QrCode.stop();
        db.ref("uang/" + decodedText).once("value").then(snapshot => {
          if (snapshot.exists()) {
            tampilkanData(snapshot.val());
          } else {
            alert("Data tidak ditemukan.");
          }
        });
      },
      (err) => { /* error callback */ }
    ).catch(err => {
      alert("Gagal membuka kamera: " + err);
    });
  </script>
</body>
</html>
