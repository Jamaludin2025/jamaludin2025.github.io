<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ucapan Pernikahan</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-100 to-purple-100 min-h-screen p-6 flex justify-center items-center">
  <div id="konten" class="bg-white p-8 rounded-2xl shadow-lg w-full max-w-[794px] text-gray-800 ring-1 ring-gray-200">

    <!-- Header -->
    <div class="mb-3 border-b pb-3 flex items-center gap-4">
      <div class="flex-1">
        <p class="font-bold">Log in sebagai <span id="kodeAksesDisplay" class="text-blue-700">KODE AKSES</span></p>
        <p class="text-sm text-gray-500">Pada <span id="lastLogin">--</span></p>
      </div>
    </div>

    <!-- Informasi Acara -->
    <div class="grid grid-cols-2 gap-y-4 mb-3">
      <div>
        <p class="text-gray-400 text-sm font-semibold">Tgl. Pernikahan</p>
        <p class="text-lg font-bold text-gray-700">20 Mei 2025</p>
      </div>
      <div>
        <p class="text-gray-400 text-sm font-semibold">Bingkisan</p>
        <p class="text-lg font-bold text-green-600">Rp35.000</p>
      </div>
      <div>
        <p class="text-gray-400 text-sm font-semibold">Nama Kerabat</p>
        <p class="text-lg font-bold">Ahmad Sajah</p>
      </div>
      <div>
        <p class="text-gray-400 text-sm font-semibold">Nama Pasangan</p>
        <p class="text-lg font-bold">Siti Rohmah</p>
      </div>
    </div>

    <!-- Alamat -->
    <div class="mb-3">
      <p class="text-gray-400 text-sm font-semibold">Alamat</p>
      <p class="text-lg font-bold leading-snug">
        Kp. Pagadungan, Rt.05 Rw.03, <br />
        Desa. Purwasari, Kec. Purwasari, Kab. Karawang
      </p>
    </div>

    <!-- Ucapan -->
    <div class="mb-3 bg-blue-50 p-4 rounded-md">
      <p class="mb-3 font-semibold text-left text-blue-800">Selamat atas pernikahannya ya . . .</p>
      <p class="text-sm leading-relaxed text-justify text-gray-700">
        Dengan pernikahan ini, maka sempurnalah kehidupan kalian. Warnailah pernikahan dengan saling menghormati,
        menyayangi, dan saling menolong dalam ketaatan satu sama lain. Semoga Alloh selalu melimpahkan petunjuk,
        rahmat, dan berkah kehidupan, serta rezeki yang halal dan keturunan yang sholih dan sholihah. Aammiin.
      </p>
    </div>

    <!-- Penutup -->
    <div class="text-right mb-4">
      <p class="mb-1 italic text-gray-600">Salam hangat,</p>
      <p class="text-lg font-semibold text-black-700">Asep Jamaludin</p>
    </div>

    <!-- Tombol Aksi -->
    <div class="text-center print:hidden flex justify-center gap-4">
      <button
        id="tombolBalas"
        onclick="balasPesan()"
        class="bg-gradient-to-r from-green-600 to-green-500 hover:from-green-700 hover:to-green-600 transition transform hover:scale-105 text-white font-semibold py-2 px-6 rounded-xl shadow-lg"
      >
        Balas Pesan
      </button>
      <button
        id="tombolCetak"
        onclick="cetakPDF()"
        class="bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 transition transform hover:scale-105 text-white font-semibold py-2 px-6 rounded-xl shadow-lg"
      >
        Unduh PDF
      </button>
      <button
        id="tombolLoginUlang"
        onclick="loginUlang()"
        class="bg-gradient-to-r from-red-700 to-red-500 hover:from-red-800 hover:to-red-600 transition transform hover:scale-105 text-white font-semibold py-2 px-6 rounded-xl shadow-lg"
        style="display: none;"
      >
        Log In Ulang
      </button>
    </div>

  </div>

  <script>
    function formatDate(date) {
      const formatted = date.toLocaleString('id-ID', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
      });
      const capitalized = formatted.charAt(0).toUpperCase() + formatted.slice(1);
      return capitalized.replace('pukul', 'Pukul');
    }

    const lastLoginEl = document.getElementById('lastLogin');
    const kodeAksesDisplay = document.getElementById('kodeAksesDisplay');
    const now = new Date();
    lastLoginEl.textContent = formatDate(now);

    function cetakPDF() {
      const element = document.getElementById('konten');
      const tombolCetak = document.getElementById('tombolCetak');
      const tombolBalas = document.getElementById('tombolBalas');
      const tombolLoginUlang = document.getElementById('tombolLoginUlang');

      tombolCetak.style.display = 'none';
      tombolBalas.style.display = 'none';
      tombolLoginUlang.style.display = 'none';

      const opt = {
        margin: [0.5, 0.5, 0.5, 0.5],
        filename: 'Ucapan dari Asep Jamaludin.pdf',
        image: { type: 'jpeg', quality: 1 },
        html2canvas: { scale: 3, useCORS: true },
        jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
      };

      html2pdf().set(opt).from(element).save().then(() => {
        tombolLoginUlang.style.display = 'inline-block';
      });
    }

    function balasPesan() {
      const tombolBalas = document.getElementById('tombolBalas');
      const tombolCetak = document.getElementById('tombolCetak');

      tombolCetak.style.display = 'none';

      const nomor = '089677484948';
      const pesan = encodeURIComponent('Tuliskan pesan Anda di sini');
      window.open(`https://wa.me/${nomor}?text=${pesan}`, '_blank');

      setTimeout(() => {
        tombolCetak.style.display = 'inline-block';
        tombolBalas.style.display = 'inline-block';
      }, 1000);
    }

    function loginUlang() {
      const urlLoginUlang = 'halamanlogin.html'; // Ganti sesuai lokasi file login kamu
      window.location.href = urlLoginUlang;
    }
  </script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "API_KEY_MU",
      authDomain: "PROJECT_ID.firebaseapp.com",
      databaseURL: "https://ajproject-log-default-rtdb.firebaseio.com/",
      projectId: "PROJECT_ID",
      storageBucket: "PROJECT_ID.appspot.com",
      messagingSenderId: "SENDER_ID",
      appId: "APP_ID"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Ambil kode akses dari URL
    const urlParams = new URLSearchParams(window.location.search);
    const kodeAkses = urlParams.get('kode') ? urlParams.get('kode').toUpperCase() : null;
    if (kodeAkses) {
      kodeAksesDisplay.textContent = kodeAkses;
      updateLogStatus(kodeAkses);
    }

    async function updateLogStatus(kode) {
  if (!kode) return;
  try {
    const snapshot = await db.ref("logAktivitas").orderByChild("kodeAkses").equalTo(kode).once("value");
    if (snapshot.exists()) {
      const logs = snapshot.val();
      let lastKey = null;
      let lastTime = 0;

      for (const key in logs) {
        if (logs[key].status === "Proses") {
          const waktuString = logs[key].waktu; // Contoh: "20-05-2025 13:45:30"
          const [tanggalStr, jamStr] = waktuString.split(" ");
          const [dd, mm, yyyy] = tanggalStr.split("-");
          const isoDateStr = `${yyyy}-${mm}-${dd}T${jamStr}`;
          const logDate = new Date(isoDateStr);

          // Validasi parsing tanggal berhasil
          if (!isNaN(logDate.getTime())) {
            if (logDate.getTime() > lastTime) {
              lastTime = logDate.getTime();
              lastKey = key;
            }
          }
        }
      }

      if (lastKey) {
        await db.ref("logAktivitas/" + lastKey).update({ status: "Berhasil" });
        console.log(`Log status untuk kode ${kode} sudah diperbarui menjadi Berhasil.`);
      }
    }
  } catch (error) {
    console.error("Gagal update status log:", error);
  }
}
  </script>
</body>
</html>
